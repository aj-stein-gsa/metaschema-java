<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MarkupVisitor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.datatype.markup.flexmark</a> &gt; <span class="el_source">MarkupVisitor.java</span></div><h1>MarkupVisitor.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.core.datatype.markup.flexmark;

import com.vladsch.flexmark.ast.AutoLink;
import com.vladsch.flexmark.ast.BlockQuote;
import com.vladsch.flexmark.ast.BulletList;
import com.vladsch.flexmark.ast.Code;
import com.vladsch.flexmark.ast.CodeBlock;
import com.vladsch.flexmark.ast.Emphasis;
import com.vladsch.flexmark.ast.FencedCodeBlock;
import com.vladsch.flexmark.ast.HardLineBreak;
import com.vladsch.flexmark.ast.Heading;
import com.vladsch.flexmark.ast.HtmlBlock;
import com.vladsch.flexmark.ast.HtmlCommentBlock;
import com.vladsch.flexmark.ast.HtmlEntity;
import com.vladsch.flexmark.ast.HtmlInline;
import com.vladsch.flexmark.ast.Image;
import com.vladsch.flexmark.ast.IndentedCodeBlock;
import com.vladsch.flexmark.ast.Link;
import com.vladsch.flexmark.ast.LinkRef;
import com.vladsch.flexmark.ast.ListItem;
import com.vladsch.flexmark.ast.MailLink;
import com.vladsch.flexmark.ast.OrderedList;
import com.vladsch.flexmark.ast.Paragraph;
import com.vladsch.flexmark.ast.Reference;
import com.vladsch.flexmark.ast.SoftLineBreak;
import com.vladsch.flexmark.ast.StrongEmphasis;
import com.vladsch.flexmark.ast.Text;
import com.vladsch.flexmark.ast.TextBase;
import com.vladsch.flexmark.ast.ThematicBreak;
import com.vladsch.flexmark.ext.gfm.strikethrough.Subscript;
import com.vladsch.flexmark.ext.superscript.Superscript;
import com.vladsch.flexmark.ext.tables.TableBlock;
import com.vladsch.flexmark.ext.typographic.TypographicQuotes;
import com.vladsch.flexmark.ext.typographic.TypographicSmarts;
import com.vladsch.flexmark.util.ast.Block;
import com.vladsch.flexmark.util.ast.Document;
import com.vladsch.flexmark.util.ast.Node;

import gov.nist.secauto.metaschema.core.datatype.markup.flexmark.InsertAnchorExtension.InsertAnchorNode;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;

import edu.umd.cs.findbugs.annotations.NonNull;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

/**
 * Supports the production of HTML content based on a markup syntax tree.
 * &lt;p&gt;
 * This implementation is stateless.
 *
 * @param &lt;T&gt;
 *          the type of stream to write to
 * @param &lt;E&gt;
 *          the type of exception that can be thrown when a writing error occurs
 */
<span class="fc" id="L60">@SuppressFBWarnings(&quot;THROWS_METHOD_THROWS_CLAUSE_THROWABLE&quot;)</span>
public class MarkupVisitor&lt;T, E extends Throwable&gt; implements IMarkupVisitor&lt;T, E&gt; {
  private final boolean handleBlockElements;

  /**
   * Construct a new visitor.
   *
   * @param handleBlockElements
   *          {@code true} process block content or {@code false} process the tree
   *          as a single line of markup
   */
<span class="fc" id="L71">  public MarkupVisitor(boolean handleBlockElements) {</span>
<span class="fc" id="L72">    this.handleBlockElements = handleBlockElements;</span>
<span class="fc" id="L73">  }</span>

  /**
   * Determine block processing state.
   *
   * @return {@code true} process block content or {@code false} process the tree
   *         as a single line of markup
   */
  protected boolean isHandleBlockElements() {
<span class="fc" id="L82">    return handleBlockElements;</span>
  }

  @Override
  public void visitDocument(Document document, IMarkupWriter&lt;T, E&gt; writer) throws E {
<span class="fc" id="L87">    visitChildren(document, writer);</span>
<span class="fc" id="L88">  }</span>

  /**
   * Process child nodes of the provided parent.
   *
   * @param parent
   *          the node whose children are to be processed
   * @param writer
   *          the markup writer used to write the HTML
   * @throws E
   *           if an error occurred while writing
   */
  protected void visitChildren(@NonNull Node parent, @NonNull IMarkupWriter&lt;T, E&gt; writer) throws E {
<span class="fc bfc" id="L101" title="All 2 branches covered.">    for (Node node : parent.getChildren()) {</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">      assert node != null;</span>
<span class="fc" id="L103">      visit(node, writer);</span>
<span class="fc" id="L104">    }</span>
<span class="fc" id="L105">  }</span>

  /**
   * Process a node.
   *
   * @param node
   *          the node to process
   * @param writer
   *          the markup writer used to write the HTML
   * @throws E
   *           if an error occurred while writing
   */
  protected void visit(@NonNull Node node, @NonNull IMarkupWriter&lt;T, E&gt; writer) throws E {
<span class="fc" id="L118">    boolean handled = processInlineElements(node, writer);</span>
<span class="pc bpc" id="L119" title="1 of 4 branches missed.">    if (!handled &amp;&amp; node instanceof Block) {</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">      if (isHandleBlockElements()) {</span>
<span class="fc" id="L121">        handled = processBlockElements(node, writer);</span>
      } else {
<span class="fc" id="L123">        visitChildren(node, writer);</span>
<span class="fc" id="L124">        handled = true;</span>
      }
    }

<span class="pc bpc" id="L128" title="1 of 2 branches missed.">    if (!handled) {</span>
<span class="nc" id="L129">      throw new UnsupportedOperationException(</span>
<span class="nc" id="L130">          String.format(&quot;Node '%s' not handled. AST: %s&quot;, node.getNodeName(), node.toAstString(true)));</span>
    }
<span class="fc" id="L132">  }</span>

  /**
   * Process a node that represents an inline element.
   *
   * @param node
   *          the node to process
   * @param writer
   *          the markup writer used to write the HTML
   * @return {@code true} if the node was processed or {@code false} otherwise
   * @throws E
   *           if an error occurred while writing
   */
  @SuppressWarnings({ &quot;PMD.CyclomaticComplexity&quot;, &quot;PMD.CognitiveComplexity&quot;, &quot;PMD.NcssCount&quot; })
  protected boolean processInlineElements(
      @NonNull Node node,
      @NonNull IMarkupWriter&lt;T, E&gt; writer) throws E { // NOPMD - acceptable
<span class="fc" id="L149">    boolean retval = true;</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">    if (node instanceof Text) {</span>
<span class="fc" id="L151">      writer.writeText((Text) node);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">    } else if (node instanceof TextBase) {</span>
<span class="fc" id="L153">      writer.writeText((TextBase) node);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">    } else if (node instanceof HtmlEntity) {</span>
<span class="fc" id="L155">      writer.writeHtmlEntity((HtmlEntity) node);</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">    } else if (node instanceof TypographicSmarts) {</span>
<span class="nc" id="L157">      writer.writeHtmlEntity((TypographicSmarts) node);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">    } else if (node instanceof TypographicQuotes) {</span>
<span class="fc" id="L159">      writer.writeTypographicQuotes((TypographicQuotes) node, this::visit);</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">    } else if (node instanceof Code) {</span>
<span class="fc" id="L161">      writer.writeCode((Code) node, this::visit);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">    } else if (node instanceof StrongEmphasis) {</span>
<span class="fc" id="L163">      writer.writeElement(&quot;strong&quot;, node, this::visit);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">    } else if (node instanceof Emphasis) {</span>
<span class="fc" id="L165">      writer.writeElement(&quot;em&quot;, node, this::visit);</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">    } else if (node instanceof ListItem) {</span>
<span class="nc" id="L167">      writer.writeElement(&quot;li&quot;, node, this::visit);</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">    } else if (node instanceof Link) {</span>
<span class="fc" id="L169">      writer.writeLink((Link) node, this::visit);</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">    } else if (node instanceof AutoLink) {</span>
<span class="fc" id="L171">      writer.writeLink((AutoLink) node);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">    } else if (node instanceof MailLink) {</span>
<span class="fc" id="L173">      writer.writeLink((MailLink) node);</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">    } else if (node instanceof Subscript) {</span>
<span class="nc" id="L175">      writer.writeElement(&quot;sub&quot;, node, this::visit);</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">    } else if (node instanceof Superscript) {</span>
<span class="nc" id="L177">      writer.writeElement(&quot;sup&quot;, node, this::visit);</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">    } else if (node instanceof Image) {</span>
<span class="fc" id="L179">      writer.writeImage((Image) node);</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">    } else if (node instanceof InsertAnchorNode) {</span>
<span class="fc" id="L181">      writer.writeInsertAnchor((InsertAnchorNode) node);</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">    } else if (node instanceof SoftLineBreak) {</span>
<span class="fc" id="L183">      writer.writeText(&quot;\n&quot;);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">    } else if (node instanceof HardLineBreak) {</span>
<span class="fc" id="L185">      writer.writeBreak((HardLineBreak) node);</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">    } else if (node instanceof HtmlInline) {</span>
<span class="nc" id="L187">      writer.writeInlineHtml((HtmlInline) node);</span>
<span class="pc bpc" id="L188" title="2 of 4 branches missed.">    } else if (node instanceof LinkRef || node instanceof Reference) {</span>
<span class="nc" id="L189">      throw new UnsupportedOperationException(</span>
<span class="nc" id="L190">          String.format(</span>
              &quot;Link references are not supported by Metaschema.&quot;
                  + &quot; Perhaps you have an unescaped bracket in the following string? %s&quot;,
<span class="nc" id="L193">              ObjectUtils.notNull(node.getParent()).getChars()));</span>
    } else {
<span class="fc" id="L195">      retval = false;</span>
    }
<span class="fc" id="L197">    return retval;</span>
  }

  /**
   * Process a node that represents a block element.
   *
   * @param node
   *          the node to process
   * @param writer
   *          the markup writer used to write the HTML
   * @return {@code true} if the node was processed or {@code false} otherwise
   * @throws E
   *           if an error occurred while writing
   */
  @SuppressWarnings(&quot;PMD.CyclomaticComplexity&quot;)
  protected boolean processBlockElements(
      @NonNull Node node,
      @NonNull IMarkupWriter&lt;T, E&gt; writer) throws E {
<span class="fc" id="L215">    boolean retval = true;</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">    if (node instanceof Paragraph) {</span>
<span class="fc" id="L217">      writer.writeParagraph((Paragraph) node, this::visit);</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">    } else if (node instanceof Heading) {</span>
<span class="fc" id="L219">      writer.writeHeading((Heading) node, this::visit);</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">    } else if (node instanceof OrderedList) {</span>
<span class="fc" id="L221">      writer.writeList(&quot;ol&quot;, (OrderedList) node, this::visit);</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">    } else if (node instanceof BulletList) {</span>
<span class="fc" id="L223">      writer.writeList(&quot;ul&quot;, (BulletList) node, this::visit);</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">    } else if (node instanceof TableBlock) {</span>
<span class="fc" id="L225">      writer.writeTable((TableBlock) node, this::visit);</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">    } else if (node instanceof HtmlBlock) {</span>
<span class="nc" id="L227">      writer.writeBlockHtml((HtmlBlock) node);</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">    } else if (node instanceof HtmlCommentBlock) {</span>
<span class="fc" id="L229">      writer.writeComment((HtmlCommentBlock) node);</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">    } else if (node instanceof IndentedCodeBlock) {</span>
<span class="fc" id="L231">      writer.writeCodeBlock((IndentedCodeBlock) node, this::visit);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">    } else if (node instanceof FencedCodeBlock) {</span>
<span class="fc" id="L233">      writer.writeCodeBlock((FencedCodeBlock) node, this::visit);</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">    } else if (node instanceof CodeBlock) {</span>
<span class="fc" id="L235">      writer.writeCodeBlock((CodeBlock) node, this::visit);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">    } else if (node instanceof BlockQuote) {</span>
<span class="fc" id="L237">      writer.writeBlockQuote((BlockQuote) node, this::visit);</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">    } else if (node instanceof ThematicBreak) {</span>
<span class="fc" id="L239">      writer.writeBreak((ThematicBreak) node);</span>
    } else {
<span class="nc" id="L241">      retval = false;</span>
    }

    // if (retval &amp;&amp; node.getNextAny(Block.class) != null) {
    // writer.writeText(&quot;\n&quot;);
    // }
<span class="fc" id="L247">    return retval;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
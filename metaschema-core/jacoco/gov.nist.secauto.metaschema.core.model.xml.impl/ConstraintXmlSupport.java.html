<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConstraintXmlSupport.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.model.xml.impl</a> &gt; <span class="el_source">ConstraintXmlSupport.java</span></div><h1>ConstraintXmlSupport.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.core.model.xml.impl;

import gov.nist.secauto.metaschema.core.datatype.IDataTypeAdapter;
import gov.nist.secauto.metaschema.core.datatype.markup.MarkupLine;
import gov.nist.secauto.metaschema.core.datatype.markup.MarkupMultiline;
import gov.nist.secauto.metaschema.core.metapath.MetapathException;
import gov.nist.secauto.metaschema.core.model.IAttributable;
import gov.nist.secauto.metaschema.core.model.IModule;
import gov.nist.secauto.metaschema.core.model.constraint.IAllowedValue;
import gov.nist.secauto.metaschema.core.model.constraint.IAllowedValuesConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.ICardinalityConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IConstraintVisitor;
import gov.nist.secauto.metaschema.core.model.constraint.IExpectConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IIndexConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IIndexHasKeyConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IKeyConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IKeyField;
import gov.nist.secauto.metaschema.core.model.constraint.ILet;
import gov.nist.secauto.metaschema.core.model.constraint.IMatchesConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IModelConstrained;
import gov.nist.secauto.metaschema.core.model.constraint.ISource;
import gov.nist.secauto.metaschema.core.model.constraint.IUniqueConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IValueConstrained;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.AllowedValueType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.AllowedValuesType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.ConstraintLetType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.ConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.DefineAssemblyConstraintsType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.DefineFieldConstraintsType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.DefineFlagConstraintsType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.ExpectConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.IndexHasKeyConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.KeyConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.KeyConstraintType.KeyField;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.MatchesConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.PropertyType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.RemarksType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedAllowedValuesConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedExpectConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedHasCardinalityConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedIndexConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedIndexHasKeyConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedKeyConstraintType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.TargetedMatchesConstraintType;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;

import org.apache.commons.lang3.tuple.Pair;
import org.apache.xmlbeans.XmlCursor;
import org.apache.xmlbeans.XmlObject;
import org.apache.xmlbeans.impl.values.XmlValueNotSupportedException;

import java.math.BigInteger;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.regex.Pattern;

import javax.xml.namespace.QName;

import edu.umd.cs.findbugs.annotations.NonNull;

@SuppressWarnings(&quot;PMD.CouplingBetweenObjects&quot;)
public final class ConstraintXmlSupport {
  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;)
  @NonNull
<span class="fc" id="L72">  private static final XmlObjectParser&lt;Pair&lt;ISource, IValueConstrained&gt;&gt; FLAG_PARSER</span>
<span class="fc" id="L73">      = new XmlObjectParser&lt;&gt;(ObjectUtils.notNull(</span>
<span class="fc" id="L74">          Map.ofEntries(</span>
<span class="fc" id="L75">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;allowed-values&quot;),</span>
                  ConstraintXmlSupport::handleAllowedValues),
<span class="fc" id="L77">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;index-has-key&quot;),</span>
                  ConstraintXmlSupport::handleIndexHasKey),
<span class="fc" id="L79">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;matches&quot;),</span>
                  ConstraintXmlSupport::handleMatches),
<span class="fc" id="L81">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;expect&quot;),</span>
<span class="fc" id="L82">                  ConstraintXmlSupport::handleExpect)))) {</span>

        @Override
        protected Handler&lt;Pair&lt;ISource, IValueConstrained&gt;&gt; identifyHandler(XmlCursor cursor, XmlObject obj) {
          Handler&lt;Pair&lt;ISource, IValueConstrained&gt;&gt; retval;
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">          if (obj instanceof AllowedValuesType) {</span>
<span class="fc" id="L88">            retval = ConstraintXmlSupport::handleAllowedValues;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">          } else if (obj instanceof IndexHasKeyConstraintType) {</span>
<span class="nc" id="L90">            retval = ConstraintXmlSupport::handleIndexHasKey;</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">          } else if (obj instanceof MatchesConstraintType) {</span>
<span class="nc" id="L92">            retval = ConstraintXmlSupport::handleMatches;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">          } else if (obj instanceof ExpectConstraintType) {</span>
<span class="nc" id="L94">            retval = ConstraintXmlSupport::handleExpect;</span>
          } else {
<span class="nc" id="L96">            retval = super.identifyHandler(cursor, obj);</span>
          }
<span class="fc" id="L98">          return retval;</span>
        }
      };

  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;)
  @NonNull
<span class="fc" id="L104">  private static final XmlObjectParser&lt;Pair&lt;ISource, IValueConstrained&gt;&gt; FIELD_PARSER</span>
<span class="fc" id="L105">      = new XmlObjectParser&lt;&gt;(ObjectUtils.notNull(</span>
<span class="fc" id="L106">          Map.ofEntries(</span>
<span class="fc" id="L107">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;allowed-values&quot;),</span>
                  ConstraintXmlSupport::handleScopedAllowedValues),
<span class="fc" id="L109">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;index-has-key&quot;),</span>
                  ConstraintXmlSupport::handleScopedIndexHasKey),
<span class="fc" id="L111">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;matches&quot;),</span>
                  ConstraintXmlSupport::handleScopedMatches),
<span class="fc" id="L113">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;expect&quot;),</span>
<span class="fc" id="L114">                  ConstraintXmlSupport::handleScopedExpect)))) {</span>

        @Override
        protected Handler&lt;Pair&lt;ISource, IValueConstrained&gt;&gt; identifyHandler(XmlCursor cursor, XmlObject obj) {
          Handler&lt;Pair&lt;ISource, IValueConstrained&gt;&gt; retval;
<span class="nc bnc" id="L119" title="All 2 branches missed.">          if (obj instanceof TargetedAllowedValuesConstraintType) {</span>
<span class="nc" id="L120">            retval = ConstraintXmlSupport::handleScopedAllowedValues;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">          } else if (obj instanceof TargetedIndexHasKeyConstraintType) {</span>
<span class="nc" id="L122">            retval = ConstraintXmlSupport::handleScopedIndexHasKey;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">          } else if (obj instanceof TargetedMatchesConstraintType) {</span>
<span class="nc" id="L124">            retval = ConstraintXmlSupport::handleScopedMatches;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">          } else if (obj instanceof TargetedExpectConstraintType) {</span>
<span class="nc" id="L126">            retval = ConstraintXmlSupport::handleScopedExpect;</span>
          } else {
<span class="nc" id="L128">            retval = super.identifyHandler(cursor, obj);</span>
          }
<span class="nc" id="L130">          return retval;</span>
        }
      };

  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;)
  @NonNull
<span class="fc" id="L136">  private static final XmlObjectParser&lt;Pair&lt;ISource, IModelConstrained&gt;&gt; ASSEMBLY_PARSER</span>
<span class="fc" id="L137">      = new XmlObjectParser&lt;&gt;(ObjectUtils.notNull(</span>
<span class="fc" id="L138">          Map.ofEntries(</span>
<span class="fc" id="L139">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;allowed-values&quot;),</span>
                  ConstraintXmlSupport::handleScopedAllowedValues),
<span class="fc" id="L141">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;index-has-key&quot;),</span>
                  ConstraintXmlSupport::handleScopedIndexHasKey),
<span class="fc" id="L143">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;matches&quot;),</span>
                  ConstraintXmlSupport::handleScopedMatches),
<span class="fc" id="L145">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;expect&quot;),</span>
                  ConstraintXmlSupport::handleScopedExpect),
<span class="fc" id="L147">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;index&quot;),</span>
                  ConstraintXmlSupport::handleScopedIndex),
<span class="fc" id="L149">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;is-unique&quot;),</span>
                  ConstraintXmlSupport::handleScopedIsUnique),
<span class="fc" id="L151">              Map.entry(new QName(IModule.XML_NAMESPACE, &quot;has-cardinality&quot;),</span>
<span class="fc" id="L152">                  ConstraintXmlSupport::handleScopedHasCardinality)))) {</span>

        @Override
        protected Handler&lt;Pair&lt;ISource, IModelConstrained&gt;&gt; identifyHandler(XmlCursor cursor, XmlObject obj) {
          Handler&lt;Pair&lt;ISource, IModelConstrained&gt;&gt; retval;
<span class="fc bfc" id="L157" title="All 2 branches covered.">          if (obj instanceof TargetedAllowedValuesConstraintType) {</span>
<span class="fc" id="L158">            retval = ConstraintXmlSupport::handleScopedAllowedValues;</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">          } else if (obj instanceof TargetedIndexHasKeyConstraintType) {</span>
<span class="nc" id="L160">            retval = ConstraintXmlSupport::handleScopedIndexHasKey;</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">          } else if (obj instanceof TargetedMatchesConstraintType) {</span>
<span class="fc" id="L162">            retval = ConstraintXmlSupport::handleScopedMatches;</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">          } else if (obj instanceof TargetedExpectConstraintType) {</span>
<span class="fc" id="L164">            retval = ConstraintXmlSupport::handleScopedExpect;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">          } else if (obj instanceof TargetedIndexConstraintType) {</span>
<span class="nc" id="L166">            retval = ConstraintXmlSupport::handleScopedIndex;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">          } else if (obj instanceof TargetedKeyConstraintType) {</span>
<span class="nc" id="L168">            retval = ConstraintXmlSupport::handleScopedIsUnique;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">          } else if (obj instanceof TargetedHasCardinalityConstraintType) {</span>
<span class="nc" id="L170">            retval = ConstraintXmlSupport::handleScopedHasCardinality;</span>
          } else {
<span class="nc" id="L172">            retval = super.identifyHandler(cursor, obj);</span>
          }
<span class="fc" id="L174">          return retval;</span>
        }

      };

  private static void parseLets(
      @NonNull List&lt;ConstraintLetType&gt; letList,
      @NonNull IValueConstrained constraints,
      @NonNull ISource source) {
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">    for (ConstraintLetType xmlLet : letList) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">      assert xmlLet != null;</span>
<span class="nc" id="L185">      ILet let = ModelFactory.newLet(xmlLet, source);</span>
<span class="nc" id="L186">      constraints.addLetExpression(let);</span>
<span class="nc" id="L187">    }</span>
<span class="fc" id="L188">  }</span>

  /**
   * Parse a set of constraints from the provided XMLBeans {@code xmlObject} and
   * apply them to the provided {@code constraints}.
   *
   * @param constraints
   *          the constraint collection to add the parsed constraints to
   * @param xmlObject
   *          the XMLBeans instance
   * @param source
   *          information about the source of the constraints
   */
  public static void parse(
      @NonNull IValueConstrained constraints,
      @NonNull DefineFlagConstraintsType xmlObject,
      @NonNull ISource source) {
<span class="fc" id="L205">    parseLets(ObjectUtils.notNull(xmlObject.getLetList()), constraints, source);</span>
<span class="fc" id="L206">    parse(</span>
        FLAG_PARSER,
        constraints,
        (XmlObject) xmlObject,
        source);
<span class="fc" id="L211">  }</span>

  /**
   * Parse a set of constraints from the provided XMLBeans {@code xmlObject} and
   * apply them to the provided {@code constraints}.
   *
   * @param constraints
   *          the constraint collection to add the parsed constraints to
   * @param xmlObject
   *          the XMLBeans instance
   * @param source
   *          information about the source of the constraints
   */
  public static void parse(
      @NonNull IValueConstrained constraints,
      @NonNull DefineFieldConstraintsType xmlObject,
      @NonNull ISource source) {
<span class="nc" id="L228">    parseLets(ObjectUtils.notNull(xmlObject.getLetList()), constraints, source);</span>
<span class="nc" id="L229">    parse(</span>
        FIELD_PARSER,
        constraints,
        (XmlObject) xmlObject,
        source);
<span class="nc" id="L234">  }</span>

  /**
   * Parse a set of constraints from the provided XMLBeans {@code xmlObject} and
   * apply them to the provided {@code constraints}.
   *
   * @param constraints
   *          the constraint collection to add the parsed constraints to
   * @param xmlObject
   *          the XMLBeans instance
   * @param source
   *          information about the source of the constraints
   */
  public static void parse(
      @NonNull IModelConstrained constraints,
      @NonNull DefineAssemblyConstraintsType xmlObject,
      @NonNull ISource source) {
<span class="fc" id="L251">    parseLets(ObjectUtils.notNull(xmlObject.getLetList()), constraints, source);</span>
<span class="fc" id="L252">    parse(</span>
        ASSEMBLY_PARSER,
        constraints,
        (XmlObject) xmlObject,
        source);
<span class="fc" id="L257">  }</span>

  private static &lt;T&gt; void parse(
      @NonNull XmlObjectParser&lt;Pair&lt;ISource, T&gt;&gt; parser,
      @NonNull T constraints,
      @NonNull XmlObject xmlObject,
      @NonNull ISource source) {
    try {
<span class="fc" id="L265">      parser.parse(xmlObject, Pair.of(source, constraints));</span>
<span class="nc" id="L266">    } catch (MetapathException | XmlValueNotSupportedException ex) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">      if (ex.getCause() instanceof MetapathException) {</span>
<span class="nc" id="L268">        throw new MetapathException(</span>
<span class="nc" id="L269">            String.format(&quot;Unable to compile a Metapath in '%s'. %s&quot;,</span>
<span class="nc" id="L270">                source.getSource(),</span>
<span class="nc" id="L271">                ex.getLocalizedMessage()),</span>
            ex);
      }
<span class="nc" id="L274">      throw ex;</span>
<span class="fc" id="L275">    }</span>
<span class="fc" id="L276">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleAllowedValues(
      @NonNull XmlObject obj,
      Pair&lt;ISource, IValueConstrained&gt; state) {
<span class="fc" id="L282">    IAllowedValuesConstraint constraint = ModelFactory.newAllowedValuesConstraint(</span>
        (AllowedValuesType) obj,
<span class="fc" id="L284">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="fc" id="L285">    state.getRight().addConstraint(constraint);</span>
<span class="fc" id="L286">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedAllowedValues(
      @NonNull XmlObject obj,
      Pair&lt;ISource, ? extends IValueConstrained&gt; state) {
<span class="fc" id="L292">    IAllowedValuesConstraint constraint = ModelFactory.newAllowedValuesConstraint(</span>
        (TargetedAllowedValuesConstraintType) obj,
<span class="fc" id="L294">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="fc" id="L295">    state.getRight().addConstraint(constraint);</span>
<span class="fc" id="L296">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleMatches(
      @NonNull XmlObject obj,
      Pair&lt;ISource, IValueConstrained&gt; state) {
<span class="nc" id="L302">    IMatchesConstraint constraint = ModelFactory.newMatchesConstraint(</span>
        (MatchesConstraintType) obj,
<span class="nc" id="L304">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L305">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L306">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedMatches(
      @NonNull XmlObject obj,
      Pair&lt;ISource, ? extends IValueConstrained&gt; state) {
<span class="fc" id="L312">    IMatchesConstraint constraint = ModelFactory.newMatchesConstraint(</span>
        (TargetedMatchesConstraintType) obj,
<span class="fc" id="L314">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="fc" id="L315">    state.getRight().addConstraint(constraint);</span>
<span class="fc" id="L316">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleIndexHasKey(
      @NonNull XmlObject obj,
      Pair&lt;ISource, IValueConstrained&gt; state) {
<span class="nc" id="L322">    IIndexHasKeyConstraint constraint = ModelFactory.newIndexHasKeyConstraint(</span>
        (IndexHasKeyConstraintType) obj,
<span class="nc" id="L324">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L325">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L326">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedIndexHasKey(
      @NonNull XmlObject obj,
      Pair&lt;ISource, ? extends IValueConstrained&gt; state) {
<span class="nc" id="L332">    IIndexHasKeyConstraint constraint = ModelFactory.newIndexHasKeyConstraint(</span>
        (TargetedIndexHasKeyConstraintType) obj,
<span class="nc" id="L334">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L335">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L336">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleExpect(
      @NonNull XmlObject obj,
      Pair&lt;ISource, IValueConstrained&gt; state) {
<span class="nc" id="L342">    IExpectConstraint constraint = ModelFactory.newExpectConstraint(</span>
        (ExpectConstraintType) obj,
<span class="nc" id="L344">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L345">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L346">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedExpect(
      @NonNull XmlObject obj,
      Pair&lt;ISource, ? extends IValueConstrained&gt; state) {
<span class="fc" id="L352">    IExpectConstraint constraint = ModelFactory.newExpectConstraint(</span>
        (TargetedExpectConstraintType) obj,
<span class="fc" id="L354">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="fc" id="L355">    state.getRight().addConstraint(constraint);</span>
<span class="fc" id="L356">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedIndex(@NonNull XmlObject obj, Pair&lt;ISource, IModelConstrained&gt; state) {
<span class="nc" id="L360">    IIndexConstraint constraint = ModelFactory.newIndexConstraint(</span>
        (TargetedIndexConstraintType) obj,
<span class="nc" id="L362">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L363">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L364">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedIsUnique(@NonNull XmlObject obj, Pair&lt;ISource, IModelConstrained&gt; state) {
<span class="nc" id="L368">    IUniqueConstraint constraint = ModelFactory.newUniqueConstraint(</span>
        (TargetedKeyConstraintType) obj,
<span class="nc" id="L370">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L371">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L372">  }</span>

  @SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
  private static void handleScopedHasCardinality(@NonNull XmlObject obj, Pair&lt;ISource, IModelConstrained&gt; state) {
<span class="nc" id="L376">    ICardinalityConstraint constraint = ModelFactory.newCardinalityConstraint(</span>
        (TargetedHasCardinalityConstraintType) obj,
<span class="nc" id="L378">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L379">    state.getRight().addConstraint(constraint);</span>
<span class="nc" id="L380">  }</span>

  private ConstraintXmlSupport() {
    // disable construction
  }

  /**
   * Generate the XMLBeans representation of a set of assembly-related
   * constraints.
   *
   * @param constraints
   *          the set of constraints
   * @return the XmlObject representation
   */
  public static DefineAssemblyConstraintsType generate(@NonNull IModelConstrained constraints) {
    // TODO: This code is orphaned. Need to implement a full writer
<span class="nc" id="L396">    DefineAssemblyConstraintsType retval = DefineAssemblyConstraintsType.Factory.newInstance();</span>

<span class="nc" id="L398">    XmlbeanGeneratingVisitor visitor = new XmlbeanGeneratingVisitor();</span>

<span class="nc bnc" id="L400" title="All 2 branches missed.">    for (IConstraint constraint : constraints.getConstraints()) {</span>
<span class="nc" id="L401">      constraint.accept(visitor, retval);</span>
<span class="nc" id="L402">    }</span>
<span class="nc" id="L403">    return retval;</span>
  }

<span class="nc" id="L406">  private static final class XmlbeanGeneratingVisitor</span>
      implements IConstraintVisitor&lt;DefineAssemblyConstraintsType, Void&gt; {

    private static void applyCommonValues(@NonNull IConstraint constraint, @NonNull ConstraintType bean) {
<span class="nc" id="L410">      MarkupLine description = constraint.getDescription();</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">      if (description != null) {</span>
<span class="nc" id="L412">        bean.setDescription(MarkupStringConverter.toMarkupLineDatatype(description));</span>
      }
<span class="nc" id="L414">      String formalName = constraint.getFormalName();</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">      if (formalName != null) {</span>
<span class="nc" id="L416">        bean.setFormalName(formalName);</span>
      }

<span class="nc" id="L419">      String id = constraint.getId();</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">      if (id != null) {</span>
<span class="nc" id="L421">        bean.setId(constraint.getId());</span>
      }

<span class="nc" id="L424">      IConstraint.Level level = constraint.getLevel();</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">      if (!IConstraint.DEFAULT_LEVEL.equals(level)) {</span>
<span class="nc" id="L426">        bean.setLevel(level);</span>
      }

<span class="nc bnc" id="L429" title="All 2 branches missed.">      for (Map.Entry&lt;IAttributable.Key, Set&lt;String&gt;&gt; entry : constraint.getProperties().entrySet()) {</span>
<span class="nc" id="L430">        IAttributable.Key key = entry.getKey();</span>
<span class="nc" id="L431">        Set&lt;String&gt; values = entry.getValue();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (String value : values) {</span>
<span class="nc" id="L433">          PropertyType prop = bean.addNewProp();</span>
<span class="nc" id="L434">          prop.setName(key.getName());</span>

<span class="nc" id="L436">          String namespace = key.getNamespace();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">          if (!IAttributable.DEFAULT_PROPERY_NAMESPACE.equals(namespace)) {</span>
<span class="nc" id="L438">            prop.setNamespace(namespace);</span>
          }
<span class="nc" id="L440">          prop.setValue(value);</span>
<span class="nc" id="L441">        }</span>
<span class="nc" id="L442">      }</span>
<span class="nc" id="L443">    }</span>

    @Override
    public Void visitAllowedValues(IAllowedValuesConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L447">      TargetedAllowedValuesConstraintType bean = state.addNewAllowedValues();</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L449">      applyCommonValues(constraint, bean);</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">      if (Boolean.compare(IAllowedValuesConstraint.ALLOW_OTHER_DEFAULT, constraint.isAllowedOther()) != 0) {</span>
<span class="nc" id="L452">        bean.setAllowOther(constraint.isAllowedOther());</span>
      }
<span class="nc" id="L454">      bean.setTarget(constraint.getTarget());</span>
<span class="nc" id="L455">      bean.setExtensible(constraint.getExtensible());</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">      for (Map.Entry&lt;String, ? extends IAllowedValue&gt; entry : constraint.getAllowedValues().entrySet()) {</span>
<span class="nc" id="L458">        String value = entry.getKey();</span>
<span class="nc" id="L459">        IAllowedValue allowedValue = entry.getValue();</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">        assert value.equals(allowedValue.getValue());</span>

<span class="nc" id="L463">        MarkupLine description = allowedValue.getDescription();</span>
<span class="nc" id="L464">        AllowedValueType enumType = bean.addNewEnum();</span>
<span class="nc" id="L465">        enumType.setValue(value);</span>

<span class="nc" id="L467">        XmlbeansMarkupVisitor.visit(description, IModule.XML_NAMESPACE, enumType);</span>
<span class="nc" id="L468">      }</span>

<span class="nc" id="L470">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L472">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L474">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L476">      return null;</span>
    }

    @Override
    public Void visitCardinalityConstraint(ICardinalityConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L481">      TargetedHasCardinalityConstraintType bean = state.addNewHasCardinality();</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L483">      applyCommonValues(constraint, bean);</span>

<span class="nc" id="L485">      Integer minOccurs = constraint.getMinOccurs();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">      if (minOccurs != null) {</span>
<span class="nc" id="L487">        bean.setMinOccurs(BigInteger.valueOf(minOccurs));</span>
      }

<span class="nc" id="L490">      Integer maxOccurs = constraint.getMaxOccurs();</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">      if (maxOccurs != null) {</span>
<span class="nc" id="L492">        bean.setMaxOccurs(BigInteger.valueOf(maxOccurs));</span>
      }

<span class="nc" id="L495">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L497">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L499">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L501">      return null;</span>
    }

    @Override
    public Void visitExpectConstraint(IExpectConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L506">      TargetedExpectConstraintType bean = state.addNewExpect();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L508">      applyCommonValues(constraint, bean);</span>

<span class="nc" id="L510">      bean.setTest(constraint.getTest());</span>

<span class="nc" id="L512">      String message = constraint.getMessage();</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">      if (message != null) {</span>
<span class="nc" id="L514">        bean.setMessage(message);</span>
      }

<span class="nc" id="L517">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L519">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L521">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L523">      return null;</span>
    }

    @Override
    public Void visitMatchesConstraint(IMatchesConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L528">      TargetedMatchesConstraintType bean = state.addNewMatches();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L530">      applyCommonValues(constraint, bean);</span>

<span class="nc" id="L532">      Pattern pattern = constraint.getPattern();</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">      if (pattern != null) {</span>
<span class="nc" id="L534">        bean.setRegex(pattern);</span>
      }

<span class="nc" id="L537">      IDataTypeAdapter&lt;?&gt; dataType = constraint.getDataType();</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">      if (dataType != null) {</span>
<span class="nc" id="L539">        bean.setDatatype(dataType);</span>
      }

<span class="nc" id="L542">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L544">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L546">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L548">      return null;</span>
    }

    private static void applyKeyFields(@NonNull IKeyConstraint constraint, @NonNull KeyConstraintType bean) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">      for (IKeyField keyField : constraint.getKeyFields()) {</span>
<span class="nc" id="L553">        KeyField keyFieldBean = bean.addNewKeyField();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">        assert keyField != null;</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">        assert keyFieldBean != null;</span>
<span class="nc" id="L556">        applyKeyField(keyField, keyFieldBean);</span>
<span class="nc" id="L557">      }</span>
<span class="nc" id="L558">    }</span>

    private static void applyKeyField(@NonNull IKeyField keyField, @NonNull KeyField bean) {
<span class="nc" id="L561">      Pattern pattern = keyField.getPattern();</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">      if (pattern != null) {</span>
<span class="nc" id="L563">        bean.setPattern(pattern);</span>
      }

<span class="nc" id="L566">      bean.setTarget(keyField.getTarget());</span>

<span class="nc" id="L568">      MarkupMultiline remarks = keyField.getRemarks();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L570">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L572">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L574">    }</span>

    @Override
    public Void visitIndexConstraint(IIndexConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L578">      TargetedIndexConstraintType bean = state.addNewIndex();</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L580">      applyCommonValues(constraint, bean);</span>
<span class="nc" id="L581">      applyKeyFields(constraint, bean);</span>

<span class="nc" id="L583">      bean.setName(constraint.getName());</span>

<span class="nc" id="L585">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L587">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L589">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L591">      return null;</span>
    }

    @Override
    public Void visitIndexHasKeyConstraint(IIndexHasKeyConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L596">      TargetedIndexHasKeyConstraintType bean = state.addNewIndexHasKey();</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L598">      applyCommonValues(constraint, bean);</span>
<span class="nc" id="L599">      applyKeyFields(constraint, bean);</span>

<span class="nc" id="L601">      bean.setName(constraint.getIndexName());</span>

<span class="nc" id="L603">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L605">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L607">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L609">      return null;</span>
    }

    @Override
    public Void visitUniqueConstraint(IUniqueConstraint constraint, DefineAssemblyConstraintsType state) {
<span class="nc" id="L614">      TargetedIndexHasKeyConstraintType bean = state.addNewIndexHasKey();</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">      assert bean != null;</span>
<span class="nc" id="L616">      applyCommonValues(constraint, bean);</span>
<span class="nc" id="L617">      applyKeyFields(constraint, bean);</span>

<span class="nc" id="L619">      MarkupMultiline remarks = constraint.getRemarks();</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">      if (remarks != null) {</span>
<span class="nc" id="L621">        RemarksType remarksType = bean.addNewRemarks();</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        assert remarksType != null;</span>
<span class="nc" id="L623">        XmlbeansMarkupVisitor.visit(remarks, IModule.XML_NAMESPACE, remarksType);</span>
      }
<span class="nc" id="L625">      return null;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>